{{- $lastMod := 0 -}}
{{- range (where .Data.Pages "Type" "events" ) }}
    {{- if gt .Lastmod $lastMod }}
        {{- $lastMod = .Lastmod }}
    {{- end }}
{{- end -}}
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//{{ (default "Jatgam Theme Calendar" .Site.Params.Events.calendarName) }}//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VTIMEZONE
TZID:America/New_York
LAST-MODIFIED:{{ dateFormat "20060102T150405Z" $lastMod }}
BEGIN:DAYLIGHT
DTSTART:19670430T020000
RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=-1SU;UNTIL=19730429T070000Z
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:STANDARD
DTSTART:19671029T020000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU;UNTIL=20061029T060000Z
TZOFFSETFROM:-0400
TZOFFSETTO:-0500
TZNAME:EST
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:19740106T020000
RDATE:19750223T020000
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:DAYLIGHT
DTSTART:19760425T020000
RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=-1SU;UNTIL=19860427T070000Z
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:DAYLIGHT
DTSTART:19870405T020000
RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=1SU;UNTIL=20060402T070000Z
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:DAYLIGHT
DTSTART:20070311T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:STANDARD
DTSTART:20071104T020000
RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
TZOFFSETFROM:-0400
TZOFFSETTO:-0500
TZNAME:EST
END:STANDARD
END:VTIMEZONE
{{- range (where .Data.Pages "Type" "events" ) }}
{{- $location := partial "location.html" . }}
{{- $startDate := .Date }}
BEGIN:VEVENT
SUMMARY:{{ with .Params.Cancelled }}CANCELLED - {{ end }}{{.Title}}
DESCRIPTION:{{ replace (.Summary | plainify) "\n" "\\n" }}
UID:{{with .Params.icsUID}}{{.}}{{else}}{{ dateFormat "20060102T150405" .Date }}{{end}}@{{ (default "jatgam-theme-calendar" .Site.Params.Events.calendarName | urlize) }}
SEQUENCE:0
STATUS:CONFIRMED
DTSTAMP:{{ dateFormat "20060102T150405Z" $startDate }}
DTSTART;TZID=America/New_York:{{ dateFormat "20060102T150405" $startDate }}
{{ with .Params.endDateTime }}DTEND;TZID=America/New_York:{{dateFormat "20060102T150405" . }}{{ end }}
LOCATION:{{with $location.page }}{{ .Params.name }}{{with .Params.address }}, {{.}}{{ end }}{{else}}{{ $location.name }}{{end}}
URL:{{.Permalink}}
END:VEVENT
{{- end }}
END:VCALENDAR